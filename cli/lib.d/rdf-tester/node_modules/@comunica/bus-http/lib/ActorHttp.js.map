{"version":3,"file":"ActorHttp.js","sourceRoot":"","sources":["ActorHttp.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IAction, IActorArgs, IActorOutput, IActorTest, Mediate } from '@comunica/core';\nimport { Actor } from '@comunica/core';\nimport { readableFromWeb } from 'readable-from-web';\n\nconst isStream = require('is-stream');\nconst toWebReadableStream = require('readable-stream-node-to-web');\n\n/**\n * A base actor for listening to HTTP events.\n *\n * Actor types:\n * * Input:  IActionHttp:      The HTTP request.\n * * Test:   IActorHttpTest:   An estimate for the response time.\n * * Output: IActorHttpOutput: The HTTP response.\n *\n * @see IActionHttp\n * @see IActorHttpTest\n * @see IActorHttpOutput\n */\nexport abstract class ActorHttp<TS = undefined> extends Actor<IActionHttp, IActorTest, IActorHttpOutput, TS> {\n  /* eslint-disable max-len */\n  /**\n   * @param args -\n   *   \\ @defaultNested {<default_bus> a <cc:components/Bus.jsonld#Bus>} bus\n   *   \\ @defaultNested {HTTP request failed: none of the configured actors were able to handle ${action.input}} busFailMessage\n   */\n  /* eslint-enable max-len */\n  public constructor(args: IActorHttpArgs<TS>) {\n    super(args);\n  }\n\n  /**\n   * Converts WhatWG streams to Node streams if required.\n   * Returns the input in case the stream already is a Node stream.\n   * @param {ReadableStream} body\n   * @returns {NodeJS.ReadableStream} A node stream.\n   */\n  public static toNodeReadable(body: ReadableStream | null): NodeJS.ReadableStream {\n    return isStream(body) || body === null ?\n      <NodeJS.ReadableStream> <any> body :\n      <NodeJS.ReadableStream> <any> readableFromWeb(body);\n  }\n\n  /**\n   * Converts Node streams to WhatWG streams.\n   * @param {NodeJS.ReadableStream} body\n   * @returns {ReadableStream} A web stream.\n   */\n  public static toWebReadableStream(body: NodeJS.ReadableStream | null): ReadableStream {\n    return toWebReadableStream(body);\n  }\n\n  /**\n   * Convert the given headers object into a raw hash.\n   * @param headers A headers object.\n   */\n  public static headersToHash(headers: Headers): Record<string, string> {\n    const hash: Record<string, string> = {};\n    // eslint-disable-next-line unicorn/no-array-for-each\n    headers.forEach((value, key) => {\n      hash[key] = value;\n    });\n    return hash;\n  }\n\n  /**\n   * Extract the requested URL from the action input.\n   * @param {RequestInfo | URL} input The request input.\n   * @returns {URL} The extracted URL.\n   */\n  public static getInputUrl(input: RequestInfo | URL): URL {\n    return new URL(input instanceof Request ? input.url : input);\n  }\n\n  /**\n   * Creates an appropriate User-Agent header string for Node.js or other environments.\n   * Within browsers, returns undefined, because the value should not be overridden due to potential CORS issues.\n   */\n  public static createUserAgent(actorName: string, actorVersion: string): string | undefined {\n    if (!ActorHttp.isBrowser()) {\n      const versions = [\n        `Comunica/${actorVersion.split('.')[0]}.0`,\n        `${actorName}/${actorVersion}`,\n      ];\n\n      if (typeof globalThis.navigator === 'object' && typeof globalThis.navigator.userAgent === 'string') {\n        // Most runtimes like Node.js 21+, Deno and Bun implement navigator.userAgent\n        versions.push(globalThis.navigator.userAgent);\n      } else if (\n        typeof globalThis.process === 'object' &&\n        typeof globalThis.process.versions === 'object' &&\n        typeof globalThis.process.versions.node === 'string'\n      ) {\n        // TODO: remove this entire 'else if' when support for Node.js 20 is dropped, this only exists for that one\n        versions.push(`Node.js/${globalThis.process.versions.node.split('.')[0]}`);\n      }\n\n      if (\n        typeof globalThis.process === 'object' &&\n        typeof globalThis.process.platform === 'string' &&\n        typeof globalThis.process.arch === 'string'\n      ) {\n        versions.splice(1, 0, `(${globalThis.process.platform}; ${globalThis.process.arch})`);\n      }\n\n      return versions.join(' ');\n    }\n  }\n\n  /**\n   * Attempts to determine whether the current environment is a browser or not.\n   * @returns {boolean} True for browsers and web workers, false for other runtimes.\n   */\n  public static isBrowser(): boolean {\n    return (\n      // The window global and the document are available in browsers, but not in web workers\n      // https://developer.mozilla.org/en-US/docs/Glossary/Global_object\n      (typeof globalThis.window === 'object' && typeof globalThis.window.document === 'object') ||\n      // The importScripts function is only available in Web Workers\n      // https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope/importScripts\n      (typeof (<any>globalThis).importScripts === 'function')\n    );\n  }\n}\n\n/**\n * The HTTP input, which contains the HTTP request.\n */\nexport interface IActionHttp extends IAction {\n  input: RequestInfo;\n  init?: RequestInit;\n}\n\n/**\n * The HTTP output, which contains the HTTP response.\n */\nexport interface IActorHttpOutput extends IActorOutput, Response {\n\n}\n\nexport type IActorHttpArgs<TS = undefined> = IActorArgs<IActionHttp, IActorTest, IActorHttpOutput, TS>;\n\nexport type MediatorHttp = Mediate<IActionHttp, IActorHttpOutput>;\n"]}